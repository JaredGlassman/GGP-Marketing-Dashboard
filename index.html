
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Good Guys Pools Performance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- External libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.4/luxon.min.js" defer></script>
<style>
  :root {
    --bg:#e6f7fb; --card:#ffffff; --muted:#4b5563; --ink:#0f172a;
    --accent:#0ea5e9; --accent2:#22d3ee; --ok:#16a34a; --okbg:#e7f7ed;
  }
  body { margin:0; background:var(--bg); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--ink);}
  .wrap{max-width:1220px; margin:0 auto; padding:20px;}
  .header{
    position:relative; border-radius:18px; padding:28px 20px 36px; overflow:hidden; color:#fff;
    background:linear-gradient(180deg, rgba(14,165,233,.85), rgba(34,211,238,.85));
  }
  .header::before{
    content:""; position:absolute; inset:0;
    background-image:url('af4092da-8a7b-45ac-8c5d-3855ea11f685.png');
    background-size:cover; background-position:center; opacity:.25;
  }
  .header > * { position:relative; }
  .header h1{margin:0 0 8px; font-size:28px; letter-spacing:.2px}
  .uploads{display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin:18px 0}
  .u{position:relative; background:var(--card); border:2px dashed #cbd5e1; border-radius:12px; padding:16px; text-align:center; transition:all .2s ease}
  .u.ok{ border-color: var(--ok); background: var(--okbg); }
  .u input{display:none}
  .u label{display:block; cursor:pointer; font-weight:700; margin-bottom:6px}
  .u .hint{color:#64748b; font-size:12px}
  .tick{position:absolute; top:8px; right:10px; font-size:18px; color:var(--ok); display:none}
  .u.ok .tick{display:block}
  .bar{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:14px 0}
  select{padding:10px 12px; border-radius:10px; border:1px solid #d1d5db; background:#fff}
  .btn{display:inline-block; padding:14px 24px; background:var(--accent); color:#fff; border:none; border-radius:12px; cursor:pointer; font-weight:800}
  .oknote{background:var(--okbg); border:1px solid #a7e7bf; color:#065f46; padding:10px 12px; border-radius:10px; margin-top:10px; display:none}
  .err{background:#fee2e2; border:1px solid #fecaca; color:#991b1b; padding:10px 12px; border-radius:10px; margin-top:10px; display:none}
  .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:14px}
  .card{background:var(--card); border-radius:14px; padding:18px; box-shadow:0 1px 2px rgba(0,0,0,.06)}
  .big{font-size:28px; font-weight:800}
  .muted{color:#64748b; text-transform:uppercase; letter-spacing:.05em; font-size:12px}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .pill{background:#dbeafe; color:#1d4ed8; padding:6px 10px; border-radius:999px; font-size:12px}
  .charts{display:grid; grid-template-columns:1fr; gap:16px; margin:18px 0}
  canvas{background:#fff; border-radius:12px; padding:10px}
  .table{overflow:auto; background:#fff; border-radius:12px; padding:10px}
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px; border-bottom:1px solid #e5e7eb; text-align:left}
  th{font-size:12px; text-transform:uppercase; color:#64748b}
  .month-checkboxes { display:flex; flex-wrap:wrap; gap:8px; max-width:100%; }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>üèä‚Äç‚ôÇÔ∏è Good Guys Pools Performance Dashboard</h1>
    <p>Track contacts from creation to close and map platform spend</p>
  </div>

  <div class="uploads">
    <div class="u" id="u-contacts"><span class="tick">‚úì</span><label for="contactsCsv">Upload Contacts CSV</label><input id="contactsCsv" type="file" accept=".csv"/><div class="hint">HubSpot contacts export</div></div>
    <div class="u" id="u-deals"><span class="tick">‚úì</span><label for="dealsCsv">Upload Deals CSV</label><input id="dealsCsv" type="file" accept=".csv"/><div class="hint">HubSpot deals export</div></div>
    <div class="u" id="u-meta"><span class="tick">‚úì</span><label for="metaCsv">Upload Meta Spend CSV</label><input id="metaCsv" type="file" accept=".csv"/><div class="hint">Meta spend</div></div>
    <div class="u" id="u-google"><span class="tick">‚úì</span><label for="googleCsv">Upload Google Ads Spend CSV</label><input id="googleCsv" type="file" accept=".csv"/><div class="hint">Google Ads (Day + Billed cost)</div></div>
    <div class="u" id="u-bing"><span class="tick">‚úì</span><label for="bingCsv">Upload Bing Spend CSV</label><input id="bingCsv" type="file" accept=".csv"/><div class="hint">Bing Ads (Date + Spend)</div></div>
    <div class="u" id="u-thumb"><span class="tick">‚úì</span><label for="thumbtackCsv">Upload Thumbtack Spend CSV</label><input id="thumbtackCsv" type="file" accept=".csv"/><div class="hint">Thumbtack (date + amount_usd)</div></div>
  </div>

  <div class="row">
    <button class="btn" id="processBtn">Process Data & Generate Dashboard</button>
    <div id="status" class="oknote">‚úÖ Data loaded</div>
    <div id="error" class="err">‚ùå A parsing error occurred. Open the console for details.</div>
  </div>

  <div class="bar">
<span class="muted">Filter by Month:</span>
<div id="monthAllTime" style="margin:0 10px 0 0;display:inline-flex;align-items:center;">
  <label style="display:inline-flex;align-items:center;margin-right:8px;">
    <input type="checkbox" id="allTimeCb"/>
    <span style="margin-left:4px;">All time</span>
  </label>
</div>
<div id="monthCheckboxes" class="month-checkboxes"></div>

    <span class="muted">Filter by Channel:</span>
<div id="channelCheckboxes" class="month-checkboxes">
  <label style="display:inline-flex;align-items:center;margin-right:8px;">
    <input type="checkbox" value="all" checked />
    <span style="margin-left:4px;">All Channels</span>
  </label>
  <label style="display:inline-flex;align-items:center;margin-right:8px;">
    <input type="checkbox" value="Meta Ads" />
    <span style="margin-left:4px;">Meta Ads</span>
  </label>
  <label style="display:inline-flex;align-items:center;margin-right:8px;">
    <input type="checkbox" value="Google Ads" />
    <span style="margin-left:4px;">Google Ads</span>
  </label>
  <label style="display:inline-flex;align-items:center;margin-right:8px;">
    <input type="checkbox" value="Bing Ads" />
    <span style="margin-left:4px;">Bing Ads</span>
  </label>
  <label style="display:inline-flex;align-items:center;margin-right:8px;">
    <input type="checkbox" value="Thumbtack" />
    <span style="margin-left:4px;">Thumbtack</span>
  </label>
  <label style="display:inline-flex;align-items:center;margin-right:8px;">
    <input type="checkbox" value="Boostmaps" />
    <span style="margin-left:4px;">Boostmaps</span>
  </label>
  <label style="display:inline-flex;align-items:center;margin-right:8px;">
    <input type="checkbox" value="Direct" />
    <span style="margin-left:4px;">Direct</span>
  </label>
</div>

    <span class="muted" id="campaignLabel" style="display:none;">FB Campaign:</span>
    <select id="campaignSel" style="display:none;"><option value="all">All Campaigns</option></select>
  </div>

  <div class="grid">
    <div class="card"><div class="big" id="leadsNum">0</div><div class="muted">Leads</div></div>
    <div class="card"><div class="big" id="svNum">0</div><div class="muted">Site Visits</div></div>
    <div class="card"><div class="big" id="svConv">0%</div><div class="muted">Site-Visit Conversion</div></div>
    <div class="card"><div class="big" id="dealSize">$0</div><div class="muted">Total Won Deal Size</div></div>
    <div class="card"><div class="big" id="closedNum">0</div><div class="muted">Closed Deals</div></div>
    <div class="card"><div class="big" id="wonNum">0</div><div class="muted">Deals Won</div></div>
    <div class="card"><div class="big" id="spend">$0</div><div class="muted">Total Spend</div></div>
    <div class="card"><div class="big" id="cpl">$0</div><div class="muted">Avg Cost / Lead</div></div>
    <div class="card"><div class="big" id="cpsv">$0</div><div class="muted">Avg Cost / Site Visit</div></div>
  </div>

  <!-- Charts -->
  <div class="charts">
    <canvas id="trend1" height="80"></canvas>  <!-- Leads / Site Visits / Won -->
    <canvas id="trend2" height="80"></canvas>  <!-- Spend -->
    <canvas id="trend3" height="80"></canvas>  <!-- CPL / CPSV -->
    <canvas id="trend4" height="80"></canvas>  <!-- Deal Size (separate) -->
  </div>

  <div class="table">
    <table id="detailTbl">
      <thead>
        <tr>
          <th>Month</th><th>Channel</th><th>Leads</th><th>Site Visits</th>
          <th>Closed</th><th>Won</th><th>Spend</th><th>CPL</th><th>CPSV</th><th>Total Won Deal Size</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
ready(()=>{
  // Channel checkbox mutual exclusivity for "All Channels"
  document.addEventListener('change', (e)=>{
    if(!(e.target && e.target.closest('#channelCheckboxes'))) return;
    const allCb = document.querySelector('#channelCheckboxes input[value="all"]');
    const others = Array.from(document.querySelectorAll('#channelCheckboxes input:not([value="all"])'));
    if(e.target.value === "all"){
      if(allCb.checked){ others.forEach(cb=>cb.checked=false); }
    } else {
      if(e.target.checked){ allCb.checked=false; }
      if(!others.some(cb=>cb.checked)) allCb.checked=true;
    }
  });
  if(typeof Papa==='undefined' || typeof Chart==='undefined' || typeof luxon==='undefined'){
    document.getElementById('error').style.display='block'; return;
  }
  [["contactsCsv","u-contacts"],["dealsCsv","u-deals"],["metaCsv","u-meta"],["googleCsv","u-google"],["bingCsv","u-bing"],["thumbtackCsv","u-thumb"]]
    .forEach(([inputId, boxId])=>{
      const input=document.getElementById(inputId), box=document.getElementById(boxId);
      input.addEventListener('change', ()=>{ if(input.files && input.files.length){ box.classList.add('ok'); } else { box.classList.remove('ok'); } });
    });

  const tz='America/New_York';
  const { DateTime } = luxon;
  let contacts=[], deals=[], spend={Meta:[], Google:[], Bing:[], Thumbtack:[]};
  let datasets={}, monthOptions=new Set();
  let metaCampaign={}, metaSpendCampaign={};

  // Smart CSV: strip report headers and keep only rows with the expected columns present
  async function parseCSVSmart(file, hint){
    const raw = await file.text();
    const lines = raw.replace(/\r\n/g, '\n').split('\n');
    let start = 0;
    const finders = {
      google: l => (/(^|,)Day(,|$)/.test(l) && /Billed\s*cost/i.test(l)),
      bing: l => /^(\"?Account name\"?,|Account name,)/.test(l),
      thumb: l => /^date,/.test(l),
      meta: l => /^\"?Reporting starts\"?,/.test(l),
      generic: l => /,/.test(l)
    };
    const test = hint==='google' ? finders.google
               : hint==='bing' ? finders.bing
               : hint==='thumb' ? finders.thumb
               : hint==='meta' ? finders.meta
               : finders.generic;
    for(let i=0;i<lines.length;i++){ if(test(lines[i])){ start=i; break; } }
    const sliced = lines.slice(start).join('\n');
    return new Promise((res,rej)=>{
      Papa.parse(sliced, {header:true,skipEmptyLines:true,complete:r=>res(r.data),error:rej});
    });
  }

  const norm=s=>(s??'').toString().trim();
  const lc=s=>norm(s).toLowerCase();
  function parseDate(str){
    if(!str) return null;
    let dt=DateTime.fromISO(str,{zone:tz}); if(dt.isValid) return dt;
    dt=DateTime.fromISO(str.replace(' ','T'),{zone:tz}); if(dt.isValid) return dt;
    const patterns=['yyyy-MM-dd','M/d/yyyy','MM/dd/yyyy','yyyy-MM-dd HH:mm:ss','M/d/yyyy H:mm','M/d/yyyy h:mm a','MMM d, yyyy'];
    for(const p of patterns){ dt=DateTime.fromFormat(str,p,{zone:tz}); if(dt.isValid) return dt; }
    try{ const js=new Date(str); if(!isNaN(js)) return DateTime.fromJSDate(js,{zone:tz}); }catch(e){}
    return null;
  }
  const monthKey=dtStr=>{ const dt=parseDate(dtStr); return dt ? dt.toFormat('yyyy-LL') : null; };
  const addMonthOption=mk=>{ if(mk) monthOptions.add(mk); };

  function mapChannelFromContact(c){
    const d1=lc(c["Original Traffic Source Drill-Down 1"]);
    const d2Raw = norm(c["Original Traffic Source Drill-Down 2"]);
    const lsc=lc(c["Lead Source (Custom)"]);
    if(lsc.includes('thumbtack')) return {channel:'Thumbtack', fbCampaign:null};
    if(d1==='crm_ui') return {channel:'Direct', fbCampaign:null};
    if(d1.includes('construction campaign')||d1.includes('service campaign')||d1.includes('maintenance campaign')||d1.includes('retargeting')||d1.includes('good guys pools website campaign updated campaign')||d1.includes('good guys pools leads - higher quality leads')||d1.includes('good guys pools leads')||d1.includes('120218493912890700')) {
      return {channel:'Meta Ads', fbCampaign: d2Raw || 'Unspecified'};
    }
    if(d1.includes('facebook')) return {channel:'Meta Ads', fbCampaign: d2Raw || 'Unspecified'};
    if(d1.includes('good guys pools search')||d1.includes('good guys pools - sales - search')||d1.includes('adwords')||d1.includes('unknown keywords')) return {channel:'Google Ads', fbCampaign:null};
    if(d1.includes('boostmaps')) return {channel:'Boostmaps', fbCampaign:null};
    if(d1.includes('bing')) return {channel:'Bing Ads', fbCampaign:null};
    if(d1.includes('instagram')||d1.includes('ig')||d1.includes('fb')||d1.includes('meta')) return {channel:'Meta Ads', fbCampaign: d2Raw || 'Unspecified'};
    if(d1) return {channel:'Direct', fbCampaign:null};
    return {channel:'Direct', fbCampaign:null};
  }

  function buildContactIndex(cs){
    const idx={byId:new Map(), byEmail:new Map(), byName:new Map()};
    cs.forEach(c=>{
      const id=norm(c["Record ID"]); if(id) idx.byId.set(id,c);
      const em=lc(c["Email"]); if(em) idx.byEmail.set(em,c);
      const nm=lc((norm(c["First Name"])+' '+norm(c["Last Name"])).trim()); if(nm) idx.byName.set(nm,c);
    }); return idx;
  }

  function matchDealToContact(deal, idx){
    const id=norm(deal["Contact ID"]); if(id && idx.byId.has(id)) return idx.byId.get(id);
    const em=lc(deal["Contact email"]); if(em && idx.byEmail.has(em)) return idx.byEmail.get(em);
    const nm=lc(deal["Contact name"]); if(nm && idx.byName.has(nm)) return idx.byName.get(nm);
    const ids=norm(deal["Associated Contact IDs"]).split(/[;,]/).map(s=>s.trim()).filter(Boolean);
    for(const i of ids){ if(idx.byId.has(i)) return idx.byId.get(i); }
    const emails=norm(deal["All Associated Contact Emails"]).split(/[;,]/).map(s=>lc(s)).filter(Boolean);
    for(const e of emails){ if(idx.byEmail.has(e)) return idx.byEmail.get(e); }
    const names=norm(deal["All Associated Contact Names"]).split(/[;,]/).map(s=>lc(s)).filter(Boolean);
    for(const n of names){ if(idx.byName.has(n)) return idx.byName.get(n); }
    return null;
  }

  function monthSpendFromRows(rows,type){
    const out={};
    rows.forEach(r=>{
      let mk=null, amt=0;
      if(type==='Meta'){
        mk=monthKey(r['Reporting starts']||r['Date']||r['Start Date']);
        amt=parseFloat((r['Amount spent (USD)']||r['Amount']||r['Spend']||'0').toString().replace(/[^0-9.\-]/g,''))||0;
        const camp=(r['Campaign name']||'Unspecified').toString().trim();
        if(mk){ if(!metaSpendCampaign[mk]) metaSpendCampaign[mk]={}; metaSpendCampaign[mk][camp]=(metaSpendCampaign[mk][camp]||0)+amt; }
      }
      if(type==='Google'){
        mk=monthKey(r['Day']||r['Date']);
        amt=parseFloat((r['Billed cost']||r['Cost']||r['Billed Cost']||'0').toString().replace(/[^0-9.\-]/g,''))||0;
      }
      if(type==='Bing'){
        mk=monthKey(r['Date']);
        amt=parseFloat((r['Spend']||r['Cost']||'0').toString().replace(/[^0-9.\-]/g,''))||0;
      }
      if(type==='Thumbtack'){
        mk=monthKey(r['date']||r['Date']);
        amt=parseFloat((r['amount_usd']||r['Amount']||'0').toString().replace(/[^0-9.\-]/g,''))||0;
      }
      if(mk){ out[mk]=(out[mk]||0)+amt; }
    });
    return out;
  }

  document.getElementById('processBtn').addEventListener('click', async ()=>{
    try{
      const [fC,fD,fM,fG,fB,fT] = ['contactsCsv','dealsCsv','metaCsv','googleCsv','bingCsv','thumbtackCsv'].map(id=>document.getElementById(id).files[0]);
      if(!fC||!fD){ alert('Upload Contacts and Deals CSVs first.'); return; }
      contacts = await parseCSVSmart(fC);
      deals = await parseCSVSmart(fD);
      if(fM) spend.Meta = await parseCSVSmart(fM,'meta');
      if(fG) spend.Google=await parseCSVSmart(fG,'google');
      if(fB) spend.Bing=await parseCSVSmart(fB,'bing');
      if(fT) spend.Thumbtack=await parseCSVSmart(fT,'thumb');

      const idx = buildContactIndex(contacts);
      const contactInfo=new Map();
      const monthSet=new Set();
      metaCampaign={}; metaSpendCampaign={};
      const perContact=new Map();

      contacts.forEach(c=>{
        const id=norm(c['Record ID']); if(!id) return;
        const mk=monthKey(c['Create Date']||c['Created Date']||c['Date Created']||c['Create date']);
        const {channel, fbCampaign} = mapChannelFromContact(c);
        contactInfo.set(id,{channel, fbCampaign, createMonth:mk});
        if(mk) monthSet.add(mk);
        if(channel==='Meta Ads'){
          const camp=(fbCampaign||'Unspecified').toString().trim();
          if(mk){
            if(!metaCampaign[mk]) metaCampaign[mk] = {};
            if(!metaCampaign[mk][camp]) metaCampaign[mk][camp] = {leads:0,sv:0,closed:0,won:0,spend:0,dealSize:0};
            metaCampaign[mk][camp].leads++;
          }
        }
        if(!perContact.has(id)) perContact.set(id,{svMonths:new Set(), closedMonths:new Set(), wonMonths:new Set(), totalWon:0});
        const svDate = norm(c['Date entered "Opportunity (Site Visit) (Lifecycle Stage Pipeline)"']);
        if(svDate){ if(mk) perContact.get(id).svMonths.add(mk); }
      });
      monthOptions=monthSet;

      deals.forEach(d=>{
        const c=matchDealToContact(d, idx); if(!c) return;
        const cid=norm(c['Record ID']); if(!cid||!contactInfo.has(cid)) return;
        const mk=contactInfo.get(cid).createMonth;
        if(!perContact.has(cid)) perContact.set(cid,{svMonths:new Set(), closedMonths:new Set(), wonMonths:new Set(), totalWon:0});
        const pc=perContact.get(cid);
        const amt=parseFloat((d['Amount']||d['AMOUNT']||d['amount']||'0').toString().replace(/[^0-9.\-]/g,''))||0;
        const stage=lc(d['Deal Stage']||d['DEAL STAGE']||d['deal stage']);
        if(mk && stage.includes('closed')) pc.closedMonths.add(mk);
        const isClosedWon = stage.includes('closed won');
        if(mk && isClosedWon) pc.wonMonths.add(mk);
        if(isClosedWon){ pc.totalWon += amt; }
      });

      perContact.forEach((pc, cid) => {
        const info = contactInfo.get(cid);
        if(!info) return;
        const mk = info.createMonth;
        if(!mk) return;
        if(info.channel === 'Meta Ads'){
          const camp = (info.fbCampaign || 'Unspecified').toString().trim();
          if(!metaCampaign[mk]) metaCampaign[mk] = {};
          if(!metaCampaign[mk][camp]) metaCampaign[mk][camp] = {leads:0,sv:0,closed:0,won:0,spend:0,dealSize:0};
          if(pc.svMonths.has(mk)) metaCampaign[mk][camp].sv++;
          if(pc.closedMonths.has(mk)) metaCampaign[mk][camp].closed++;
          if(pc.wonMonths.has(mk)) metaCampaign[mk][camp].won++;
          metaCampaign[mk][camp].dealSize += pc.totalWon;
        }
      });

      const spendMonth={
        'Meta Ads': monthSpendFromRows(spend.Meta,'Meta'),
        'Google Ads': monthSpendFromRows(spend.Google,'Google'),
        'Bing Ads': monthSpendFromRows(spend.Bing,'Bing'),
        'Thumbtack': monthSpendFromRows(spend.Thumbtack,'Thumbtack'),
        'Boostmaps':{}
      };
      Object.entries(metaSpendCampaign).forEach(([mk,obj])=>{
        Object.entries(obj).forEach(([camp,amt])=>{
          if(!metaCampaign[mk]) metaCampaign[mk]={};
          if(!metaCampaign[mk][camp]) metaCampaign[mk][camp] = {leads:0,sv:0,closed:0,won:0,spend:0,dealSize:0};
          metaCampaign[mk][camp].spend += amt;
        });
      });

      datasets={}; monthOptions.forEach(mk=>{
        ['Meta Ads','Google Ads','Bing Ads','Thumbtack','Boostmaps','Direct'].forEach(ch=>{
          if(!datasets[mk]) datasets[mk] = {};
          datasets[mk][ch] = {leads:0, sv:0, closed:0, won:0, spend:0, dealSize:0};
        });
      });
      const processedIDs = new Set();
      contacts.forEach(c=>{
        const id = norm(c['Record ID']); if(!id) return;
        if(processedIDs.has(id)) return; processedIDs.add(id);
        const info = contactInfo.get(id); if(!info) return;
        const mk = info.createMonth; if(!mk || !datasets[mk]) return;
        const ch = info.channel;
        datasets[mk][ch].leads++;
        if(perContact.has(id)) datasets[mk][ch].dealSize += perContact.get(id).totalWon;
        if(perContact.has(id) && perContact.get(id).svMonths.has(mk)) datasets[mk][ch].sv++;
        if(perContact.has(id) && perContact.get(id).closedMonths.has(mk)) datasets[mk][ch].closed++;
        if(perContact.has(id) && perContact.get(id).wonMonths.has(mk)) datasets[mk][ch].won++;
      });
      Object.keys(datasets).forEach(mk=>{
        Object.keys(datasets[mk]).forEach(ch=>{
          let s=0;
          if(ch==='Meta Ads') s=spendMonth['Meta Ads'][mk]||0;
          if(ch==='Google Ads') s=spendMonth['Google Ads'][mk]||0;
          if(ch==='Bing Ads') s=spendMonth['Bing Ads'][mk]||0;
          if(ch==='Thumbtack') s=spendMonth['Thumbtack'][mk]||0;
          if(ch==='Boostmaps') s=900;
          datasets[mk][ch].spend = s;
        });
      });

      document.getElementById('status').style.display='inline-block';
      fillMonthOptions(); fillCampaignOptions(); render();
    } catch(e){ console.error(e); const el=document.getElementById('error'); el.style.display='inline-block'; el.textContent='‚ùå '+e.message; }
  });

  function fillMonthOptions(){
    const allTimeEl = document.getElementById('allTimeCb');
    if(allTimeEl) allTimeEl.addEventListener('change', ()=>{ render(); });
    const container = document.getElementById('monthCheckboxes');
    container.innerHTML = '';
    const months = Array.from(monthOptions).sort();
    const { DateTime } = luxon;
    months.forEach(m => {
      const wrapper = document.createElement('label');
      wrapper.style.display='inline-flex'; wrapper.style.alignItems='center'; wrapper.style.marginRight='8px';
      const cb = document.createElement('input');
      cb.type='checkbox'; cb.value=m; cb.addEventListener('change', ()=>{ fillCampaignOptions(); render(); });
      const text = document.createElement('span'); text.style.marginLeft='4px';
      try{ text.textContent = DateTime.fromFormat(m, 'yyyy-LL').toFormat('LLLL yyyy'); } catch{ text.textContent=m; }
      wrapper.appendChild(cb); wrapper.appendChild(text); container.appendChild(wrapper);
    });
  }

  function fillCampaignOptions(){
    const channelCbsCont=document.getElementById('channelCheckboxes');
    const selectedChannels = Array.from(document.querySelectorAll('#channelCheckboxes input:checked')).map(cb=>cb.value);
    const lab=document.getElementById('campaignLabel');
    const sel=document.getElementById('campaignSel');
    if(!(selectedChannels.length === 1 && selectedChannels[0] === 'Meta Ads')){
      lab.style.display='none'; sel.style.display='none'; return;
    }
    const selectedMonths = Array.from(document.querySelectorAll('#monthCheckboxes input:checked')).map(cb => cb.value);
    const months = selectedMonths.length === 0 ? Object.keys(metaCampaign) : selectedMonths;
    const campaigns=new Set();
    months.forEach(mk=>{
      const obj=metaCampaign[mk]||{};
      Object.keys(obj).forEach(c=>{ const data=obj[c]; if(data && data.leads>0) campaigns.add(c); });
    });
    sel.innerHTML='<option value="all">All Campaigns</option>';
    [...campaigns].sort().forEach(c=>{ const opt=document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt); });
    lab.style.display='inline'; sel.style.display='inline';
  }

  const colorMap = {'Meta Ads':'#2563eb','Google Ads':'#f97316','Bing Ads':'#16a34a','Thumbtack':'#f59e0b','Boostmaps':'#ec4899','Direct':'#8b5cf6','all':'#2563eb'};
  function lightenColor(hex, percent){
    hex = hex.replace('#',''); const num = parseInt(hex, 16); const amt = Math.round(2.55 * percent);
    let R = (num >> 16) + amt; let G = (num >> 8 & 0x00FF) + amt; let B = (num & 0x0000FF) + amt;
    R = R < 255 ? (R < 0 ? 0 : R) : 255; G = G < 255 ? (G < 0 ? 0 : G) : 255; B = B < 255 ? (B < 0 ? 0 : B) : 255;
    return '#' + (0x1000000 + (R * 0x10000) + (G * 0x100) + B).toString(16).slice(1);
  }
  function seriesFor(months, channel, key, campaign=null){
    return months.map(m=>{
      if(channel==='Meta Ads' && campaign && campaign!=='all'){ return metaCampaign[m]?.[campaign]?.[key]||0; }
      const val = channel==='all' ? Object.values(datasets[m]||{}).reduce((a,x)=>a+(x[key]||0),0) : (datasets[m]?.[channel]?.[key]||0);
      return val;
    });
  }

  let ch1,ch2,ch3,ch4;
  function render(){
    const allTime = document.getElementById('allTimeCb')?.checked;
    const selectedMonthsArr = Array.from(document.querySelectorAll('#monthCheckboxes input:checked')).map(cb => cb.value);
    const months = (allTime || selectedMonthsArr.length === 0) ? Object.keys(datasets).sort() : selectedMonthsArr;
    const channelCbsCont=document.getElementById('channelCheckboxes');
    const selectedChannelsArr = Array.from(document.querySelectorAll('#channelCheckboxes input:checked')).map(cb => cb.value);
    const allChannels = ['Meta Ads','Google Ads','Bing Ads','Thumbtack','Boostmaps','Direct'];
    const channels = (selectedChannelsArr.includes('all') || selectedChannelsArr.length === 0) ? allChannels : selectedChannelsArr;
    const camp = document.getElementById('campaignSel').value;

    let agg = {leads:0, sv:0, closed:0, won:0, spend:0, dealSize:0};
    let rows = [];
    months.forEach(m => {
      channels.forEach(ch => {
        let d;
        if(ch === 'Meta Ads' && camp && camp !== 'all'){ d = metaCampaign[m]?.[camp] || {leads:0, sv:0, closed:0, won:0, spend:0, dealSize:0}; }
        else { d = datasets[m]?.[ch] || {leads:0, sv:0, closed:0, won:0, spend:0, dealSize:0}; }
        rows.push({ month:m, channel: ch + ((ch === 'Meta Ads' && camp && camp !== 'all') ? ` (${camp})` : ''),
          leads:d.leads, sv:d.sv, closed:d.closed, won:d.won, spend:d.spend,
          cpl: d.leads ? d.spend/d.leads : 0, cpsv: d.sv ? d.spend/d.sv : 0, dealSize:d.dealSize });
        agg.leads+=d.leads; agg.sv+=d.sv; agg.closed+=d.closed; agg.won+=d.won; agg.spend+=d.spend; agg.dealSize+=d.dealSize;
      });
    });

    const money = n => '$' + (n || 0).toLocaleString(undefined, { maximumFractionDigits: 2 });
    const pct = n => (n || 0).toFixed(1) + '%';
    document.getElementById('leadsNum').textContent = agg.leads.toLocaleString();
    document.getElementById('svNum').textContent = agg.sv.toLocaleString();
    document.getElementById('svConv').textContent = pct(agg.leads ? (agg.sv / agg.leads * 100) : 0);
    document.getElementById('dealSize').textContent = money(agg.dealSize);
    document.getElementById('closedNum').textContent = agg.closed.toLocaleString();
    document.getElementById('wonNum').textContent = agg.won.toLocaleString();
    document.getElementById('spend').textContent = money(agg.spend);
    document.getElementById('cpl').textContent = agg.leads ? money(agg.spend / agg.leads) : '$0';
    document.getElementById('cpsv').textContent = agg.sv ? money(agg.spend / agg.sv) : '$0';

    const tb = document.querySelector('#detailTbl tbody'); tb.innerHTML='';
    const { DateTime } = luxon;
    rows.forEach(r => {
      const tr = document.createElement('tr');
      let human; try { human = DateTime.fromFormat(r.month, 'yyyy-LL').toFormat('LLLL yyyy'); } catch { human = r.month; }
      tr.innerHTML = `<td>${human}</td><td>${r.channel}</td><td>${r.leads}</td><td>${r.sv}</td><td>${r.closed}</td><td>${r.won}</td><td>${money(r.spend)}</td><td>${r.leads ? money(r.spend / r.leads) : "$0"}</td><td>${r.sv ? money(r.spend / r.sv) : "$0"}</td><td>${money(r.dealSize)}</td>`;
      tb.appendChild(tr);
    });

    const labels = months.map(m => { try { return DateTime.fromFormat(m, 'yyyy-LL').toFormat('LLL yy'); } catch { return m; } });
    if(ch1) ch1.destroy(); if(ch2) ch2.destroy(); if(ch3) ch3.destroy(); if(ch4) ch4.destroy();
    const useAggregated = (selectedChannelsArr.includes('all') || selectedChannelsArr.length === 0);

    // Trend 1: Leads / Site Visits / Won (Deal Size removed)
    const chart1Datasets = [];
    const chanList = useAggregated ? ['all'] : channels;
    (useAggregated ? ['all'] : channels).forEach(ch => {
      const base = colorMap[ch] || colorMap['all'];
      chart1Datasets.push({ label: (useAggregated?'All Channels':'') + (useAggregated?'':' '+ch) + ' Leads', data: seriesFor(months, ch, useAggregated?'leads':'leads', camp), tension:.3, borderColor: base, backgroundColor: base+'33' });
      chart1Datasets.push({ label: (useAggregated?'All Channels':'') + (useAggregated?'':' '+ch) + ' Site Visits', data: seriesFor(months, ch, 'sv', camp), tension:.3, borderColor: lightenColor(base, 30), backgroundColor: lightenColor(base, 30)+'33', borderDash:[6,4] });
      chart1Datasets.push({ label: (useAggregated?'All Channels':'') + (useAggregated?'':' '+ch) + ' Won Deals', data: seriesFor(months, ch, 'won', camp), tension:.3, borderColor: lightenColor(base, 50), backgroundColor: lightenColor(base, 50)+'33', borderDash:[4,4] });
    });
    ch1 = new Chart(document.getElementById('trend1'), { type:'line', data:{labels, datasets:chart1Datasets}, options:{responsive:true, scales:{y:{beginAtZero:true}}} });

    // Trend 2: Spend (channel or aggregated)
    const chart2Datasets = [];
    (useAggregated ? ['all'] : channels).forEach(ch => {
      const base = colorMap[ch] || colorMap['all'];
      chart2Datasets.push({ label: (useAggregated?'All Channels':'') + (useAggregated?'':' '+ch) + ' Spend ($)', data: seriesFor(months, ch, 'spend', camp), tension:.3, borderColor: base, backgroundColor: base+'33' });
    });
    ch2 = new Chart(document.getElementById('trend2'), { type:'line', data:{labels, datasets:chart2Datasets}, options:{responsive:true, scales:{y:{beginAtZero:true}}} });

    // Trend 3: CPL / CPSV
    const chart3Datasets = [];
    (useAggregated ? ['all'] : channels).forEach(ch => {
      const base = colorMap[ch] || colorMap['all']; const lighter = lightenColor(base, 30);
      const spendSeries = seriesFor(months, ch, 'spend', camp);
      const leadsSeries = seriesFor(months, ch, 'leads', camp);
      const svSeries = seriesFor(months, ch, 'sv', camp);
      const cplSeries = spendSeries.map((s,i)=>{ const l=leadsSeries[i]; return l ? s/l : 0; });
      const cpsvSeries = spendSeries.map((s,i)=>{ const v=svSeries[i]; return v ? s/v : 0; });
      chart3Datasets.push({ label: (useAggregated?'All Channels':'') + (useAggregated?'':' '+ch) + ' CPL', data:cplSeries, tension:.3, borderColor:base, backgroundColor:base+'33' });
      chart3Datasets.push({ label: (useAggregated?'All Channels':'') + (useAggregated?'':' '+ch) + ' CPSV', data:cpsvSeries, tension:.3, borderColor:lighter, backgroundColor:lighter+'33', borderDash:[6,4] });
    });
    ch3 = new Chart(document.getElementById('trend3'), { type:'line', data:{labels, datasets:chart3Datasets}, options:{responsive:true, scales:{y:{beginAtZero:true}}} });

    // Trend 4: Deal Size (separate)
    const chart4Datasets = [];
    (useAggregated ? ['all'] : channels).forEach(ch => {
      const base = colorMap[ch] || colorMap['all'];
      chart4Datasets.push({ label: (useAggregated?'All Channels':'') + (useAggregated?'':' '+ch) + ' Deal Size ($)', data: seriesFor(months, ch, 'dealSize', camp), tension:.3, borderColor: base, backgroundColor: base+'33' });
    });
    ch4 = new Chart(document.getElementById('trend4'), { type:'line', data:{labels, datasets:chart4Datasets}, options:{responsive:true, scales:{y:{beginAtZero:true}}} });
  }

  document.getElementById('channelCheckboxes').addEventListener('change', ()=>{ fillCampaignOptions(); render(); });
  document.getElementById('campaignSel').addEventListener('change', render);
  
});
</script>
</body>
</html>
