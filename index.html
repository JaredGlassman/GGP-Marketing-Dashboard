<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Meta Lead Performance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- External libs -->
<!-- External libs loaded without integrity/crossorigin to avoid local SRI issues -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.4/luxon.min.js"></script>
<style>
  :root {
    --bg:#f2f4f8; --card:#fff; --muted:#6b7280; --ink:#0f172a; --accent:#7c5cff;
    --pill:#e9e5ff; --ok:#16a34a; --warn:#f59e0b;
  }
  body { margin:0; background:var(--bg); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--ink);}
  .wrap{max-width:1200px; margin:0 auto; padding:20px;}
  .header{background:linear-gradient(90deg,#57c1eb,#6a88f7); color:#fff; border-radius:16px; padding:28px; text-align:center;}
  .header h1{margin:0 0 8px; font-size:28px}
  .uploads{display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin:18px 0}
  .u{background:var(--card); border:2px dashed #cbd5e1; border-radius:12px; padding:16px; text-align:center}
  .u input{display:none}
  .u label{display:block; cursor:pointer; font-weight:600; margin-bottom:6px}
  .u .hint{color:var(--muted); font-size:12px}

  /* Highlight upload boxes when a file is selected */
  .u{position:relative; transition:background 0.3s, border-color 0.3s;}
  .u.uploaded{border-color:#86efac; background:#f0fdf4;}
  .u.uploaded::after{
    content:"\2714"; /* Check mark character */
    color:#16a34a;
    font-size:20px;
    font-weight:700;
    position:absolute;
    top:6px;
    right:8px;
  }
  .bar{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:14px 0}
  select{padding:10px 12px; border-radius:10px; border:1px solid #d1d5db; background:#fff}
  .btn{display:inline-block; padding:14px 24px; background:#7c5cff; color:#fff; border:none; border-radius:12px; cursor:pointer; font-weight:700}
  .ok{background:#e7f7ed; border:1px solid #a7e7bf; color:#065f46; padding:10px 12px; border-radius:10px; margin-top:10px; display:none}
  .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:14px}
  .card{background:var(--card); border-radius:14px; padding:18px; box-shadow:0 1px 2px rgba(0,0,0,.06)}
  .big{font-size:28px; font-weight:800}
  .muted{color:var(--muted); text-transform:uppercase; letter-spacing:.05em; font-size:12px}
  .row{display:flex; gap:14px; flex-wrap:wrap; align-items:center}
  .pill{background:var(--pill); color:#4f46e5; padding:6px 10px; border-radius:999px; font-size:12px}
  .charts{display:grid; grid-template-columns:1fr; gap:16px; margin:18px 0}
  canvas{background:#fff; border-radius:12px; padding:10px}
  .table{overflow:auto; background:#fff; border-radius:12px; padding:10px}
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px; border-bottom:1px solid #e5e7eb; text-align:left}
  th{font-size:12px; text-transform:uppercase; color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>ðŸ“Š Meta Lead Performance Dashboard</h1>
    <p>Track contacts from creation to close and map platform spend</p>
  </div>

  <!-- Uploaders -->
  <div class="uploads">
    <div class="u"><label for="contactsCsv">Upload Contacts CSV</label><input id="contactsCsv" type="file" accept=".csv"/><div class="hint">HubSpot contacts export</div></div>
    <div class="u"><label for="dealsCsv">Upload Deals CSV</label><input id="dealsCsv" type="file" accept=".csv"/><div class="hint">HubSpot deals export</div></div>
    <div class="u"><label for="metaCsv">Upload Meta Spend CSV</label><input id="metaCsv" type="file" accept=".csv"/><div class="hint">Meta spend</div></div>
    <div class="u"><label for="googleCsv">Upload Google Ads Spend CSV</label><input id="googleCsv" type="file" accept=".csv"/><div class="hint">Google Ads spend</div></div>
    <div class="u"><label for="bingCsv">Upload Bing Spend CSV</label><input id="bingCsv" type="file" accept=".csv"/><div class="hint">Bing Ads spend</div></div>
    <div class="u"><label for="thumbtackCsv">Upload Thumbtack Spend CSV</label><input id="thumbtackCsv" type="file" accept=".csv"/><div class="hint">Thumbtack spend</div></div>
  </div>

  <div class="row">
    <button class="btn" id="processBtn">Process Data & Generate Dashboard</button>
    <div id="status" class="ok">âœ… Data loaded</div>
  </div>

  <!-- Filters -->
  <div class="bar">
    <span class="muted">Filter by Stage:</span>
    <select id="stageSel">
      <option value="create">Contact Created Date</option>
      <option value='lead'>Entered "Lead"</option>
      <option value='oppty'>Entered "Opportunity (Site Visit)"</option>
      <option value='won'>Entered "Closed Won"</option>
      <option value='lost'>Entered "Closed Lost"</option>
    </select>

    <span class="muted">Filter by Month:</span>
    <select id="monthSel"><option value="all">All Months</option></select>

    <span class="muted">Filter by Channel:</span>
    <select id="channelSel"><option value="all">All Channels</option>
      <option>Meta Ads</option><option>Google Ads</option><option>Bing Ads</option>
      <option>Thumbtack</option><option>Boostmaps</option><option>Direct</option>
    </select>
    <span class="pill" id="fbCampaignPill" style="display:none;"></span>
  </div>

  <!-- Metric cards -->
  <div class="grid">
    <div class="card"><div class="big" id="leadsNum">0</div><div class="muted">Leads</div></div>
    <div class="card"><div class="big" id="svNum">0</div><div class="muted">Site Visits</div></div>
    <div class="card"><div class="big" id="svConv">0%</div><div class="muted">Site-Visit Conversion</div></div>
    <div class="card"><div class="big" id="dealSize">$0</div><div class="muted">Total Deal Size</div></div>
    <div class="card"><div class="big" id="closedNum">0</div><div class="muted">Closed Deals</div></div>
    <div class="card"><div class="big" id="wonNum">0</div><div class="muted">Deals Won</div></div>
    <div class="card"><div class="big" id="spend">$0</div><div class="muted">Total Spend</div></div>
    <div class="card"><div class="big" id="cpl">$0</div><div class="muted">Avg Cost / Lead</div></div>
    <div class="card"><div class="big" id="cpsv">$0</div><div class="muted">Avg Cost / Site Visit</div></div>
  </div>

  <!-- Charts -->
  <div class="charts">
    <canvas id="trend1" height="80"></canvas>
    <canvas id="trend2" height="80"></canvas>
    <canvas id="trend3" height="80"></canvas>
  </div>

  <!-- Detail table -->
  <div class="table">
    <table id="detailTbl">
      <thead>
        <tr>
          <th>Month</th><th>Channel</th><th>Leads</th><th>Site Visits</th>
          <th>Closed</th><th>Won</th><th>Spend</th><th>CPL</th><th>CPSV</th><th>Total Deal Size</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const tz = "America/New_York";
const { DateTime } = luxon;

// Data holders
let contacts=[], deals=[];
let spend={Meta:[], Google:[], Bing:[], Thumbtack:[]};
let datasets={}; // month x channel aggregation
let monthOptions=new Set();

// =========== Utilities ===========
function parseCSV(file){ return new Promise((res,rej)=>{
  Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>res(r.data),error:rej});
});}
function norm(s){ return (s??"").toString().trim(); }
function lc(s){ return norm(s).toLowerCase(); }
function money(n){ return "$"+(n||0).toLocaleString(undefined,{maximumFractionDigits:2}); }
function pct(n){ return (n||0).toFixed(1)+"%"; }
function monthKey(dtStr){
  if(!dtStr) return null;
  let dt = DateTime.fromISO(dtStr,{zone:tz});
  if(!dt.isValid){ dt = DateTime.fromISO(dtStr.replace(" ","T"),{zone:tz}); }
  if(!dt.isValid) return null;
  return dt.toFormat("yyyy-LL");
}
function addMonthOption(mk){ if(mk){ monthOptions.add(mk); }}

// Channel mapping â€” precedence & overrides per your spec
function mapChannelFromContact(c){
  const d1 = lc(c["Original Traffic Source Drill-Down 1"]);
  const d2 = lc(c["Original Traffic Source Drill-Down 2"]);
  const lsc = lc(c["Lead Source (Custom)"]);
  if(lsc.includes("thumbtack")) return {channel:"Thumbtack", fbCampaign:null};
  if(d1==="crm_ui") return {channel:"Direct", fbCampaign:null};
  if(d1.includes("facebook")) return {channel:"Meta Ads", fbCampaign: d2 || null};
  if(d1.includes("good guys pools search") || d1.includes("good guys pools - sales - search") || d1.includes("adwords") || d1.includes("unknown keywords")) return {channel:"Google Ads", fbCampaign:null};
  if(d1.includes("boostmaps")) return {channel:"Boostmaps", fbCampaign:null};
  if(d1.includes("bing")) return {channel:"Bing Ads", fbCampaign:null};
  if(d1.includes("instagram")||d1.includes("ig")||d1.includes("fb")||d1.includes("meta")) return {channel:"Meta Ads", fbCampaign:d2||null};
  if(d1) return {channel:"Direct", fbCampaign:null};
  return {channel:"Direct", fbCampaign:null};
}

// Site visit rule (unique per contact per month)
function dealIsSiteVisit(deal){
  const stage = lc(deal["Deal Stage"]||deal["DEAL STAGE"]||deal["deal stage"]);
  const amtRaw = deal["Amount"]||deal["AMOUNT"]||deal["amount"]||"0";
  const amt = parseFloat(amtRaw.toString().replace(/[^0-9.\-]/g,""))||0;
  const appt = stage.includes("appointment") && stage.includes("scheduled");
  const tier = (stage.includes("quote") && stage.includes("provided")) || stage.includes("closed won") || stage.includes("closed lost");
  return appt || (tier && amt>24000);
}

// Join precedence and *first* contact wins (no duplication)
function matchDealToContact(deal, contactIndex){
  const tryId = norm(deal["Contact ID"]);
  if(tryId && contactIndex.byId.has(tryId)) return contactIndex.byId.get(tryId);
  const tryEmail = lc(deal["Contact email"]);
  if(tryEmail && contactIndex.byEmail.has(tryEmail)) return contactIndex.byEmail.get(tryEmail);
  const tryName = lc(deal["Contact name"]);
  if(tryName && contactIndex.byName.has(tryName)) return contactIndex.byName.get(tryName);
  const ids = norm(deal["Associated Contact IDs"]).split(/[;,]/).map(s=>s.trim()).filter(Boolean);
  for(const id of ids){ if(contactIndex.byId.has(id)) return contactIndex.byId.get(id); }
  const emails = norm(deal["All Associated Contact Emails"]).split(/[;,]/).map(s=>lc(s)).filter(Boolean);
  for(const em of emails){ if(contactIndex.byEmail.has(em)) return contactIndex.byEmail.get(em); }
  const names = norm(deal["All Associated Contact Names"]).split(/[;,]/).map(s=>lc(s)).filter(Boolean);
  for(const nm of names){ if(contactIndex.byName.has(nm)) return contactIndex.byName.get(nm); }
  return null;
}

// Build contact index
function buildContactIndex(contacts){
  const idx={byId:new Map(), byEmail:new Map(), byName:new Map()};
  contacts.forEach(c=>{
    const id = norm(c["Record ID"]);
    if(id) idx.byId.set(id,c);
    const em = lc(c["Email"]);
    if(em) idx.byEmail.set(em,c);
    const nm = lc(norm(c["First Name"]) + " " + norm(c["Last Name"])).trim();
    if(nm) idx.byName.set(nm,c);
  });
  return idx;
}

// Parse spend CSVs to month sums
function monthSpendFromRows(rows, type){
  const out = {};
  rows.forEach(r=>{
    let mk=null, amt=0;
    if(type==="Meta"){ mk = monthKey(r["Reporting starts"]||r["Date"]||r["Start Date"]); amt = parseFloat((r["Amount spent (USD)"]||r["Amount"]||r["Spend"]||"0").toString().replace(/[^0-9.\-]/g,""))||0; }
    if(type==="Google"){ mk = monthKey(r["Day"]||r["Date"]); amt = parseFloat((r["Billed cost"]||r["Cost"]||"0").toString().replace(/[^0-9.\-]/g,""))||0; }
    if(type==="Bing"){ mk = monthKey(r["Date"]); amt = parseFloat((r["Spend"]||r["Cost"]||"0").toString().replace(/[^0-9.\-]/g,""))||0; }
    if(type==="Thumbtack"){ mk = monthKey(r["date"]||r["Date"]); amt = parseFloat((r["amount_usd"]||r["Amount"]||"0").toString().replace(/[^0-9.\-]/g,""))||0; }
    if(mk){ out[mk]=(out[mk]||0)+amt; }
  });
  return out;
}

// =========== Main processing ===========
document.getElementById("processBtn").addEventListener("click", async ()=>{
  const [fC,fD,fM,fG,fB,fT] = ["contactsCsv","dealsCsv","metaCsv","googleCsv","bingCsv","thumbtackCsv"].map(id=>document.getElementById(id).files[0]);
  if(!fC || !fD){ alert("Upload Contacts and Deals CSVs first."); return; }
  contacts = await parseCSV(fC); deals = await parseCSV(fD);
  if(fM) spend.Meta = await parseCSV(fM); if(fG) spend.Google = await parseCSV(fG);
  if(fB) spend.Bing = await parseCSV(fB); if(fT) spend.Thumbtack = await parseCSV(fT);
  const cIndex = buildContactIndex(contacts);
  const contactInfo = new Map();
  contacts.forEach(c=>{
    const id = norm(c["Record ID"]); if(!id) return;
    const mk = monthKey(c["Create Date"]||c["Created Date"]||c["Date Created"]||c["Create date"]);
    const {channel, fbCampaign} = mapChannelFromContact(c);
    contactInfo.set(id,{
      channel, fbCampaign,
      createMonth: mk,
      stageDates:{
        lead: c['Date entered "Lead (Lifecycle Stage Pipeline)"'] || null,
        oppty: c['Date entered "Opportunity (Site Visit) (Lifecycle Stage Pipeline)"'] || null,
        won: c['Date entered "Customer (Lifecycle Stage Pipeline)"'] || c['Date entered "Closed Won"'] || null,
        lost: c['Date entered "Lead Closed (Lifecycle Stage Pipeline)"'] || c['Date entered "Closed Lost"'] || null
      }
    });
    addMonthOption(mk);
  });
  const perContact = new Map();
  deals.forEach(d=>{
    const c = matchDealToContact(d, cIndex); if(!c) return;
    const cid = norm(c["Record ID"]); if(!cid || !contactInfo.has(cid)) return;
    const contactCreateMonth = contactInfo.get(cid).createMonth;
    if(contactCreateMonth){
      const sv = dealIsSiteVisit(d);
      if(sv){
        if(!perContact.has(cid)) perContact.set(cid,{siteVisitByMonth:new Set(), totalDeal:0, closedByMonth:new Set(), wonByMonth:new Set()});
        perContact.get(cid).siteVisitByMonth.add(contactCreateMonth);
      }
    }
    const amtRaw = d["Amount"]||d["AMOUNT"]||d["amount"]||"0";
    const amt = parseFloat(amtRaw.toString().replace(/[^0-9.\-]/g,""))||0;
    if(!perContact.has(cid)) perContact.set(cid,{siteVisitByMonth:new Set(), totalDeal:0, closedByMonth:new Set(), wonByMonth:new Set()});
    perContact.get(cid).totalDeal += amt;
    const stage = lc(d["Deal Stage"]||d["DEAL STAGE"]||d["deal stage"]);
    const isClosed = stage.includes("closed");
    const isWon = stage.includes("closed won");
    if(isClosed && contactCreateMonth) perContact.get(cid).closedByMonth.add(contactCreateMonth);
    if(isWon && contactCreateMonth) perContact.get(cid).wonByMonth.add(contactCreateMonth);
  });
  const spendMonth = {
    "Meta Ads": monthSpendFromRows(spend.Meta,"Meta"),
    "Google Ads": monthSpendFromRows(spend.Google,"Google"),
    "Bing Ads": monthSpendFromRows(spend.Bing,"Bing"),
    "Thumbtack": monthSpendFromRows(spend.Thumbtack,"Thumbtack"),
    "Boostmaps": {} // fixed below
  };
  datasets = {}; monthOptions.forEach(mk=>{
    ["Meta Ads","Google Ads","Bing Ads","Thumbtack","Boostmaps","Direct"].forEach(ch=>{
      if(!datasets[mk]) datasets[mk]={};
      datasets[mk][ch] = {leads:0, sv:0, closed:0, won:0, spend:0, dealSize:0, fbCampaign:null};
    });
  });
  contacts.forEach(c=>{
    const cid = norm(c["Record ID"]); if(!cid) return;
    const info = contactInfo.get(cid); if(!info) return;
    const mk = info.createMonth; if(!mk || !datasets[mk]) return;
    const ch = info.channel;
    datasets[mk][ch].leads += 1;
    if(perContact.has(cid)) datasets[mk][ch].dealSize += perContact.get(cid).totalDeal;
    if(perContact.has(cid) && perContact.get(cid).siteVisitByMonth.has(mk)) datasets[mk][ch].sv += 1;
    if(perContact.has(cid) && perContact.get(cid).closedByMonth.has(mk)) datasets[mk][ch].closed += 1;
    if(perContact.has(cid) && perContact.get(cid).wonByMonth.has(mk)) datasets[mk][ch].won += 1;
    if(ch==="Meta Ads" && info.fbCampaign) datasets[mk][ch].fbCampaign = info.fbCampaign;
  });
  Object.keys(datasets).forEach(mk=>{
    Object.keys(datasets[mk]).forEach(ch=>{
      let s=0;
      if(ch==="Meta Ads") s = spendMonth["Meta Ads"][mk]||0;
      if(ch==="Google Ads") s = spendMonth["Google Ads"][mk]||0;
      if(ch==="Bing Ads") s = spendMonth["Bing Ads"][mk]||0;
      if(ch==="Thumbtack") s = spendMonth["Thumbtack"][mk]||0;
      if(ch==="Boostmaps") s = 900;
      datasets[mk][ch].spend = s;
    });
  });
  const monthSel = document.getElementById("monthSel");
  monthSel.innerHTML = '<option value="all">All Months</option>';
  [...monthOptions].sort().forEach(m=>{
    const opt=document.createElement("option"); opt.value=m; opt.textContent=DateTime.fromFormat(m,"yyyy-LL").toFormat("LLLL yyyy"); monthSel.appendChild(opt);
  });
  document.getElementById("status").style.display="inline-block";
  render();
});

// =========== Rendering ===========
let ch1,ch2,ch3;
function render(){
  const stage = document.getElementById("stageSel").value;
  const mk = document.getElementById("monthSel").value;
  const channel = document.getElementById("channelSel").value;
  let agg = {leads:0, sv:0, closed:0, won:0, spend:0, dealSize:0};
  let rows=[];
  const months = mk==="all" ? Object.keys(datasets).sort() : [mk];
  months.forEach(m=>{
    const channels = channel==="all" ? Object.keys(datasets[m]) : [channel];
    channels.forEach(ch=>{
      const d = datasets[m][ch];
      const row = {
        month:m, channel:ch, leads:d.leads, sv:d.sv, closed:d.closed, won:d.won,
        spend:d.spend, cpl:d.leads?d.spend/d.leads:0, cpsv:d.sv?d.spend/d.sv:0,
        dealSize:d.dealSize, fbCampaign:d.fbCampaign
      };
      rows.push(row);
      agg.leads += row.leads; agg.sv += row.sv; agg.closed += row.closed; agg.won += row.won; agg.spend += row.spend; agg.dealSize += row.dealSize;
      const pill=document.getElementById("fbCampaignPill");
      if(ch==="Meta Ads" && row.fbCampaign && months.length===1 && channel!=="all"){
        pill.style.display="inline-block"; pill.textContent="FB Campaign: "+row.fbCampaign;
      } else if(pill){ pill.style.display="none"; }
    });
  });
  document.getElementById("leadsNum").textContent = agg.leads.toLocaleString();
  document.getElementById("svNum").textContent = agg.sv.toLocaleString();
  const svConv = agg.leads ? (agg.sv/agg.leads*100) : 0;
  document.getElementById("svConv").textContent = pct(svConv);
  document.getElementById("dealSize").textContent = money(agg.dealSize);
  document.getElementById("closedNum").textContent = agg.closed.toLocaleString();
  document.getElementById("wonNum").textContent = agg.won.toLocaleString();
  document.getElementById("spend").textContent = money(agg.spend);
  document.getElementById("cpl").textContent = agg.leads? money(agg.spend/agg.leads) : "$0";
  document.getElementById("cpsv").textContent = agg.sv? money(agg.spend/agg.sv) : "$0";
  const tb = document.querySelector("#detailTbl tbody"); tb.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    const human=DateTime.fromFormat(r.month,"yyyy-LL").toFormat("LLLL yyyy");
    tr.innerHTML=`<td>${human}</td><td>${r.channel}</td><td>${r.leads}</td><td>${r.sv}</td><td>${r.closed}</td><td>${r.won}</td>
      <td>${money(r.spend)}</td><td>${r.leads?money(r.spend/r.leads):"$0"}</td><td>${r.sv?money(r.spend/r.sv):"$0"}</td><td>${money(r.dealSize)}</td>`;
    tb.appendChild(tr);
  });
  const labels = months.map(m=>DateTime.fromFormat(m,"yyyy-LL").toFormat("LLL yy"));
  const series = k=>months.map(m=>{
    const d = channel==="all"
      ? Object.values(datasets[m]).reduce((a,x)=>a+(x[k]||0),0)
      : (datasets[m][channel]?.[k]||0);
    return d;
  });
  const cfgLine = (ctx, lbl, arr, color="#7c5cff", yId="y")=>new Chart(ctx,{
    type:"line", data:{labels, datasets:[{label:lbl, data:arr, tension:.3, borderColor:color, backgroundColor:color+"33"}]},
    options:{responsive:true, scales:{[yId]:{beginAtZero:true}}}
  });
  if(ch1) ch1.destroy(); if(ch2) ch2.destroy(); if(ch3) ch3.destroy();
  ch1 = cfgLine(document.getElementById("trend1"), "Leads / Site Visits", series("leads"), "#6a88f7");
  ch1.data.datasets.push({label:"Site Visits", data:series("sv"), borderColor:"#16a34a", backgroundColor:"#16a34a33", tension:.3}); ch1.update();
  ch2 = cfgLine(document.getElementById("trend2"), "Deal Size vs Spend ($)", series("dealSize"), "#fb923c");
  ch2.data.datasets.push({label:"Spend", data:series("spend"), borderColor:"#ef4444", backgroundColor:"#ef444433", tension:.3}); ch2.update();
  const cplSeries = months.map((m,i)=>{ const l = series("leads")[i]; const s = series("spend")[i]; return l? s/l : 0; });
  const cpsvSeries = months.map((m,i)=>{ const sv = series("sv")[i]; const s = series("spend")[i]; return sv? s/sv : 0; });
  ch3 = cfgLine(document.getElementById("trend3"), "Cost Metrics", cplSeries, "#7c5cff");
  ch3.data.datasets.push({label:"CPSV", data:cpsvSeries, borderColor:"#10b981", backgroundColor:"#10b98133", tension:.3}); ch3.update();
}
document.getElementById("monthSel").addEventListener("change", render);
document.getElementById("channelSel").addEventListener("change", render);
document.getElementById("stageSel").addEventListener("change", render);

// Highlight upload boxes when a file is selected
document.querySelectorAll('.uploads input[type="file"]').forEach(input => {
  input.addEventListener('change', () => {
    const box = input.closest('.u');
    if (box) {
      box.classList.add('uploaded');
    }
  });
});
</script>
</body>
</html>